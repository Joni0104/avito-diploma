databaseChangeLog:
  - changeSet:
      id: 1
      author: dashulya
      changes:
        # 1. Создаем таблицу images ПЕРВОЙ
        - createTable:
            tableName: images
            columns:
              - column:
                  name: id
                  type: SERIAL
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: file_path
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: file_size
                  type: BIGINT
              - column:
                  name: media_type
                  type: VARCHAR(50)
              - column:
                  name: data
                  type: BYTEA

        # 2. Создаем таблицу users (ссылается на images)
        - createTable:
            tableName: users
            columns:
              - column:
                  name: id
                  type: SERIAL
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: email
                  type: VARCHAR(32)
                  constraints:
                    unique: true
                    nullable: false
              - column:
                  name: password
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: first_name
                  type: VARCHAR(16)
                  constraints:
                    nullable: false
              - column:
                  name: last_name
                  type: VARCHAR(16)
                  constraints:
                    nullable: false
              - column:
                  name: phone
                  type: VARCHAR(20)
              - column:
                  name: role
                  type: VARCHAR(10)
                  constraints:
                    nullable: false
                    default: USER
              - column:
                  name: image_id
                  type: INT
                  constraints:
                    nullable: true

        # 3. Создаем таблицу ads (ссылается на users и images)
        - createTable:
            tableName: ads
            columns:
              - column:
                  name: id
                  type: SERIAL
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: title
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
              - column:
                  name: price
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: author_id
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: image_id
                  type: INT
                  constraints:
                    nullable: true

        # 4. Создаем таблицу comments (ссылается на users и ads)
        - createTable:
            tableName: comments
            columns:
              - column:
                  name: id
                  type: SERIAL
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: text
                  type: VARCHAR(64)
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: author_id
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: ad_id
                  type: INT
                  constraints:
                    nullable: false

        # 5. Добавляем внешние ключи ОТДЕЛЬНО
        - addForeignKeyConstraint:
            baseTableName: users
            baseColumnNames: image_id
            referencedTableName: images
            referencedColumnNames: id
            constraintName: fk_user_image
            onDelete: SET NULL

        - addForeignKeyConstraint:
            baseTableName: ads
            baseColumnNames: author_id
            referencedTableName: users
            referencedColumnNames: id
            constraintName: fk_ad_user
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: ads
            baseColumnNames: image_id
            referencedTableName: images
            referencedColumnNames: id
            constraintName: fk_ad_image
            onDelete: SET NULL

        - addForeignKeyConstraint:
            baseTableName: comments
            baseColumnNames: author_id
            referencedTableName: users
            referencedColumnNames: id
            constraintName: fk_comment_user
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: comments
            baseColumnNames: ad_id
            referencedTableName: ads
            referencedColumnNames: id
            constraintName: fk_comment_ad
            onDelete: CASCADE